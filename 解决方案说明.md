# Cloudflare 部署解密问题解决方案

## 问题分析

通过分析 Cloudflare 构建日志和本地测试，我们发现了数据文件解密失败的根本原因：

1. **问题本质**：加密文件是先用 Fernet 加密，再进行 Base64 编码。而原始解密脚本尝试直接解密而不先进行 Base64 解码，导致解密失败。

2. **错误信息**：
   - `Invalid Fernet token version`
   - `wrong final block length`
   - `bad decrypt`

3. **解密流程错误**：
   - 原始解密脚本直接读取加密文件，但未识别出文件内容是 Base64 编码过的
   - 正确流程应该是：Base64 解码 → Fernet 解密

## 解决方案

我们已经修复了解密脚本，正确处理了文件解密流程：

1. **修复的解密脚本**：
   - 添加了 Base64 解码步骤
   - 正确识别 Fernet 格式令牌
   - 提取 IV 和密文
   - 使用 AES 解密

2. **环境变量设置**：
   - 密钥：`SeS1+J7QZI2sIi4fDF3ObSuDuUN1L3yLOimJFkKTEjg=`
   - 注意：使用标准 Base64 格式，含 `+` 字符而非 `-` 字符

3. **Cloudflare 环境变量配置**：
   - 确保在 Cloudflare Pages 中将环境变量类型设置为"纯文本"而非"密钥"
   - 密钥值需要完全一致，包括 `+` 字符

## 验证结果

修复后的脚本可以成功解密所有 8 个加密文件：
- en/monthly_rank.enc → JSON 包含 500 条记录
- en/total_rank.enc → JSON 包含 1000 条记录
- en/income_rank.enc → JSON 包含 486 条记录
- en/region_rank.enc → JSON 包含 500 条记录
- zh/monthly_rank.enc → JSON 包含 500 条记录
- zh/total_rank.enc → JSON 包含 1000 条记录
- zh/income_rank.enc → JSON 包含 486 条记录
- zh/region_rank.enc → JSON 包含 500 条记录

## 实施步骤

1. **更新 Cloudflare 环境变量**：
   - 变量名：`DECRYPT_KEY`
   - 变量值：`SeS1+J7QZI2sIi4fDF3ObSuDuUN1L3yLOimJFkKTEjg=`
   - 变量类型：纯文本 (Text)

2. **更新解密脚本**：
   - 我们已经更新了 `decrypt_build.cjs` 文件，确保它使用正确的解密流程

3. **简化构建脚本**：
   - 已更新 `cloudflare-build.sh` 脚本，使其更简洁并添加环境变量检查

4. **重新部署**：
   - 使用更新后的脚本和环境变量配置重新部署项目

## 技术细节

Fernet 令牌格式：
- 第 0 字节：版本标识符 (0x80)
- 第 1-8 字节：当前时间戳
- 第 9-24 字节：初始化向量 (IV)
- 第 25-(n-32) 字节：密文
- 最后 32 字节：HMAC

解密过程：
1. Base64 解码加密文件内容
2. 验证解码后数据的第一个字节是否为 0x80 (Fernet 令牌)
3. 提取 IV (位置 9-24)
4. 提取密文 (位置 25 到末尾减去 32 字节)
5. 使用 AES-128-CBC 进行解密
6. 解析解密后的 JSON 数据

本文档记录了解决方案，以便未来参考。 